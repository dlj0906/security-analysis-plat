var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,s=(t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n,o=(e,t)=>{for(var r in t||(t={}))l.call(t,r)&&s(e,r,t[r]);if(n)for(var r of n(t))a.call(t,r)&&s(e,r,t[r]);return e},c=(e,t,r)=>s(e,"symbol"!=typeof t?t+"":t,r),i=(e,t,r)=>new Promise((n,l)=>{var a=e=>{try{o(r.next(e))}catch(t){l(t)}},s=e=>{try{o(r.throw(e))}catch(t){l(t)}},o=e=>e.done?n(e.value):Promise.resolve(e.value).then(a,s);o((r=r.apply(e,t)).next())});import{d as u,a0 as f,V as h,c as d,a8 as m,j as p,a as y,T as g,ae as v,b8 as C,z as b,l as A,b9 as E,ba as R,bb as L,a9 as S,ai as z,ao as T,r as O,o as w,au as j,bc as x,n as P}from"./index-Bt2F3fsx.js";import{P as _,i as N,a as $}from"./vnode-D7OjJs6e.js";import{a as k}from"./index-DKTFZ-Eh.js";import{u as U}from"./useTableColumns-CBjkK4nZ.js";const K=u({name:"ElSpaceItem",props:f({prefixCls:{type:String}}),setup(e,{slots:t}){const r=h("space"),n=d(()=>`${e.prefixCls||r.b()}__item`);return()=>m("div",{class:n.value},p(t,"default"))}}),D={small:8,default:12,large:16};const I=T(u({name:"ElSpace",props:f({direction:{type:String,values:["horizontal","vertical"],default:"horizontal"},class:{type:z([String,Object,Array]),default:""},style:{type:z([String,Array,Object]),default:""},alignment:{type:z(String),default:"center"},prefixCls:{type:String},spacer:{type:z([Object,String,Number,Array]),default:null,validator:e=>E(e)||C(e)||S(e)},wrap:Boolean,fill:Boolean,fillRatio:{type:Number,default:100},size:{type:[String,Array,Number],values:L,validator:e=>C(e)||v(e)&&2===e.length&&e.every(C)}}),setup(e,{slots:t}){const{classes:r,containerStyle:n,itemStyle:l}=function(e){const t=h("space"),r=d(()=>[t.b(),t.m(e.direction),e.class]),n=y(0),l=y(0),a=d(()=>[e.wrap||e.fill?{flexWrap:"wrap"}:{},{alignItems:e.alignment},{rowGap:`${l.value}px`,columnGap:`${n.value}px`},e.style]),s=d(()=>e.fill?{flexGrow:1,minWidth:`${e.fillRatio}%`}:{});return g(()=>{const{size:t="small",wrap:r,direction:a,fill:s}=e;if(v(t)){const[e=0,r=0]=t;n.value=e,l.value=r}else{let e;e=C(t)?t:D[t||"small"]||D.small,(r||s)&&"horizontal"===a?n.value=l.value=e:"horizontal"===a?(n.value=e,l.value=0):(l.value=e,n.value=0)}}),{classes:r,containerStyle:a,itemStyle:s}}(e);function a(t,r="",n=[]){const{prefixCls:s}=e;return t.forEach((e,t)=>{N(e)?v(e.children)&&e.children.forEach((e,t)=>{N(e)&&v(e.children)?a(e.children,`${r+t}-`,n):E(e)&&(null==e?void 0:e.type)===R?n.push(e):n.push(b(K,{style:l.value,prefixCls:s,key:`nested-${r+t}`},{default:()=>[e]},_.PROPS|_.STYLE,["style","prefixCls"]))}):$(e)&&n.push(b(K,{style:l.value,prefixCls:s,key:`LoopKey${r+t}`},{default:()=>[e]},_.PROPS|_.STYLE,["style","prefixCls"]))}),n}return()=>{var s;const{spacer:o,direction:c}=e,i=p(t,"default",{key:0},()=>[]);if(0===(null!=(s=i.children)?s:[]).length)return null;if(v(i.children)){let e=a(i.children);if(o){const t=e.length-1;e=e.reduce((e,r,n)=>{const a=[...e,r];return n!==t&&a.push(b("span",{style:[l.value,"vertical"===c?"width: 100%":null],key:n},[E(o)?o:A(o,_.TEXT)],_.STYLE)),a},[])}return b("div",{class:r.value,style:n.value},e,_.STYLE|_.CLASS)}return i.children}}}));var B=(e=>(e.CLEAR_ALL="clear_all",e.CLEAR_CURRENT="clear_current",e.CLEAR_PAGINATION="clear_pagination",e.KEEP_ALL="keep_all",e))(B||{});class G{constructor(e=3e5,t=50,r=!1){c(this,"cache",new Map),c(this,"cacheTime"),c(this,"maxSize"),c(this,"enableLog"),this.cacheTime=e,this.maxSize=t,this.enableLog=r}log(e,...t){this.enableLog}generateKey(e){if(!e||"object"!=typeof e)return JSON.stringify(e);const t=this.sortObjectKeys(e);return JSON.stringify(t)}sortObjectKeys(e){const t={},r=Object.keys(e).sort();for(const n of r){const r=e[n];r&&"object"==typeof r&&!Array.isArray(r)?t[n]=this.sortObjectKeys(r):t[n]=r}return t}generateTags(e){const t=new Set,r=Object.keys(e).filter(t=>!["current","size","total"].includes(t)&&void 0!==e[t]&&""!==e[t]&&null!==e[t]);if(r.length>0){const n=r.map(t=>`${t}:${String(e[t])}`).join("|");t.add(`search:${n}`)}else t.add("search:default");return t.add(`pagination:${e.size||10}`),t.add("pagination"),t}evictLRU(){if(this.cache.size<=this.maxSize)return;let e="",t=1/0,r=1/0;for(const[n,l]of this.cache.entries())(l.accessCount<t||l.accessCount===t&&l.lastAccessTime<r)&&(e=n,t=l.accessCount,r=l.lastAccessTime);e&&(this.cache.delete(e),this.log(`LRU 清理缓存: ${e}`))}set(e,t,r){const n=this.generateKey(e),l=this.generateTags(e),a=Date.now();this.evictLRU(),this.cache.set(n,{data:t,response:r,timestamp:a,params:n,tags:l,accessCount:1,lastAccessTime:a})}get(e){const t=this.generateKey(e),r=this.cache.get(t);return r?Date.now()-r.timestamp>this.cacheTime?(this.cache.delete(t),null):(r.accessCount++,r.lastAccessTime=Date.now(),r):null}clearByTags(e){let t=0;for(const[r,n]of this.cache.entries()){e.some(e=>Array.from(n.tags).some(t=>t.includes(e)))&&(this.cache.delete(r),t++)}return t}clearCurrentSearch(e){const t=this.generateKey(e);return this.cache.delete(t)?1:0}clearPagination(){return this.clearByTags(["pagination"])}clear(){this.cache.clear()}getStats(){const e=this.cache.size;let t=0,r=0;for(const n of this.cache.values())t+=JSON.stringify(n.data).length,r+=n.accessCount;return{total:e,size:`${(t/1024).toFixed(2)}KB`,hitRate:`${e>0?(r/e).toFixed(1):"0"} avg hits`}}cleanupExpired(){let e=0;const t=Date.now();for(const[r,n]of this.cache.entries())t-n.timestamp>this.cacheTime&&(this.cache.delete(r),e++);return e}}const F=["list","data","records","items","result","rows"],M=["total","count"],W=["current","page","pageNum"],Y=["size","pageSize","limit"];function J(e,t){for(const r of t)if(r in e&&Array.isArray(e[r]))return e[r];return[]}function q(e,t,r){for(const n of r)if(n in e&&"number"==typeof e[n])return e[n];return t.length}function H(e,t){const r={},n=[e,null!=t?t:{}],l=W;for(const s of n){for(const e of l)if(e in s&&"number"==typeof s[e]){r.current=s[e];break}if(void 0!==r.current)break}const a=Y;for(const s of n){for(const e of a)if(e in s&&"number"==typeof s[e]){r.size=s[e];break}if(void 0!==r.size)break}if(void 0!==r.current||void 0!==r.size)return r}const Q=e=>{const t=F;if(!e)return{records:[],total:0};if(Array.isArray(e))return{records:e,total:e.length};if("object"!=typeof e)return{records:[],total:0};const r=e;let n,l=[],a=0;if(l=J(r,t),a=q(r,l,M),n=H(r),0===l.length&&"data"in r&&"object"==typeof r.data){const e=r.data;l=J(e,["list","records","items"]),a=q(e,l,M),n=H(r,e),Array.isArray(r.data)&&(l=r.data,a=l.length)}!t.some(e=>e in r)&&l.length;const s={records:l,total:a};return n&&Object.assign(s,n),s},V=(e,t)=>{var r,n;e.total=null!=(n=null!=(r=t.total)?r:e.total)?n:0,void 0!==t.current&&(e.current=t.current);const l=Math.max(1,Math.ceil(e.total/(e.size||1)));e.current>l&&(e.current=l)};function X(e){return function(e){const{core:{apiFn:n,apiParams:l={},excludeParams:a=[],immediate:s=!0,columnsFactory:c,paginationKey:u={current:"current",size:"size"}},transform:{dataTransformer:f,responseAdapter:h=Q}={},performance:{enableCache:m=!1,cacheTime:p=3e5,debounceTime:g=300,maxCacheSize:v=50}={},hooks:{onSuccess:C,onError:b,onCacheHit:A,resetFormCallback:E}={},debug:{enableLog:R=!1}={}}=e,L=(null==u?void 0:u.current)||"current",S=(null==u?void 0:u.size)||"size",z=y(0),T={log:(e,...t)=>{},warn:(e,...t)=>{},error:(e,...t)=>{}},_=m?new G(p,v,R):null,N=y(!1),$=y(null),K=y([]);let D=null,I=null;const F=O(Object.assign({[L]:1,[S]:10},l||{})),M=O({current:F[L]||1,size:F[S]||10,total:0}),{width:W}=k(),Y=d(()=>{return e=o({},M),n={small:W.value<768},t(e,r(n));var e,n}),J=c?U(c):null,q=null==J?void 0:J.columns,H=null==J?void 0:J.columnChecks,X=d(()=>K.value.length>0),Z=d(()=>(z.value,_?_.getStats():{total:0,size:"0KB",hitRate:"0 avg hits"})),ee=(e=>{const t=(e,...t)=>{};return(r,n)=>{const l={code:"UNKNOWN_ERROR",message:"未知错误",details:r};return r instanceof Error?(l.message=r.message,l.code=r.name):"string"==typeof r&&(l.message=r),t(`${n}:`,r),null==e||e(l),l}})(b,R),te=(e,t)=>{if(!_)return;let r=0;switch(e){case B.CLEAR_ALL:_.clear(),T.log(`清空所有缓存 - ${t||""}`);break;case B.CLEAR_CURRENT:r=_.clearCurrentSearch(F),T.log(`清空当前搜索缓存 ${r} 条 - ${t||""}`);break;case B.CLEAR_PAGINATION:r=_.clearPagination(),T.log(`清空分页缓存 ${r} 条 - ${t||""}`);break;case B.KEEP_ALL:default:T.log(`保持缓存不变 - ${t||""}`)}z.value++},re=(e,...t)=>i(null,[e,...t],function*(e,t=m){D&&D.abort();const r=new AbortController;D=r,N.value=!0,$.value=null;try{let l=Object.assign({},F,{[L]:M.current,[S]:M.size},e||{});if(a.length>0){const e=o({},l);a.forEach(t=>{delete e[t]}),l=e}if(t&&_){const e=_.get(l);if(e)return K.value=e.data,V(M,e.response),F[L]!==M.current&&(F[L]=M.current),F[S]!==M.size&&(F[S]=M.size),N.value=!1,A&&A(e.data,e.response),T.log("缓存命中"),e.response}const s=yield n(l);if(r.signal.aborted)throw new Error("请求已取消");const c=h(s);let i=(e=>{const t=e.records||e.data||[];return Array.isArray(t)?t:[]})(c);return f&&(i=f(i)),K.value=i,V(M,c),F[L]!==M.current&&(F[L]=M.current),F[S]!==M.size&&(F[S]=M.size),t&&_&&(_.set(l,i,c),z.value++,T.log("数据已缓存")),C&&C(i,c),c}catch(l){if(l instanceof Error&&"请求已取消"===l.message)return{records:[],total:0,current:1,size:10};K.value=[];throw ee(l,"获取表格数据失败")}finally{N.value=!1,D===r&&(D=null)}}),ne=e=>i(null,null,function*(){try{return yield re(e)}catch(t){return Promise.resolve()}}),le=e=>i(null,null,function*(){M.current=1,F[L]=1,te(B.CLEAR_CURRENT,"搜索数据");try{return yield re(e,!1)}catch(t){return Promise.resolve()}}),ae=((e,t)=>{let r=null,n=null,l=null,a=null;const s=(...s)=>new Promise((o,c)=>{r&&clearTimeout(r),n=s,l=o,a=c,r=setTimeout(()=>i(null,null,function*(){try{const t=yield e(...s);o(t)}catch($){c($)}finally{r=null,n=null,l=null,a=null}}),t)});return s.cancel=()=>{r&&clearTimeout(r),r=null,n=null,l=null,a=null},s.flush=()=>i(null,null,function*(){if(r&&n&&l&&a){clearTimeout(r),r=null;const t=n,s=l,o=a;n=null,l=null,a=null;try{const r=yield e(...t);return s(r),r}catch($){throw o($),$}}return Promise.resolve()}),s})(le,g),se=()=>i(null,null,function*(){ae.cancel();const e={[L]:1,[S]:F[S]||10};Object.keys(F).forEach(e=>{delete F[e]}),Object.assign(F,l||{},e),M.current=1,M.size=e[S],$.value=null,te(B.CLEAR_ALL,"重置搜索"),yield ne(),E&&(yield P(),E())});let oe=!1;const ce=e=>i(null,null,function*(){e<=0||(ae.cancel(),M.size=e,M.current=1,F[S]=e,F[L]=1,te(B.CLEAR_CURRENT,"分页大小变化"),yield ne())}),ie=e=>i(null,null,function*(){if(!(e<=0||oe))if(M.current!==e)try{oe=!0,M.current=e,F[L]!==e&&(F[L]=e),yield ne()}finally{oe=!1}else T.log("分页页码未变化，跳过请求")}),ue=()=>i(null,null,function*(){ae.cancel(),M.current=1,F[L]=1,te(B.CLEAR_PAGINATION,"新增数据"),yield ne()}),fe=()=>i(null,null,function*(){te(B.CLEAR_CURRENT,"编辑数据"),yield ne()}),he=()=>i(null,null,function*(){const{current:e}=M;te(B.CLEAR_CURRENT,"删除数据"),yield ne(),0===K.value.length&&e>1&&(M.current=e-1,F[L]=e-1,yield ne())}),de=()=>i(null,null,function*(){ae.cancel(),te(B.CLEAR_ALL,"手动刷新"),yield ne()}),me=()=>i(null,null,function*(){te(B.CLEAR_CURRENT,"软刷新"),yield ne()}),pe=()=>{D&&D.abort(),ae.cancel()},ye=()=>{K.value=[],$.value=null,te(B.CLEAR_ALL,"清空数据")},ge=()=>{if(!_)return 0;const e=_.cleanupExpired();return e>0&&z.value++,e};m&&_&&(I=setInterval(()=>{const e=_.cleanupExpired();e>0&&(T.log(`自动清理 ${e} 条过期缓存`),z.value++)},p/2));s&&w(()=>i(null,null,function*(){yield ne()}));return j(()=>{pe(),_&&_.clear(),I&&clearInterval(I)}),o({data:K,loading:x(N),error:x($),isEmpty:d(()=>0===K.value.length),hasData:X,pagination:x(M),paginationMobile:Y,handleSizeChange:ce,handleCurrentChange:ie,searchParams:F,resetSearchParams:se,fetchData:ne,getData:le,getDataDebounced:ae,clearData:ye,refreshData:de,refreshSoft:me,refreshCreate:ue,refreshUpdate:fe,refreshRemove:he,cacheInfo:Z,clearCache:te,clearExpiredCache:ge,cancelRequest:pe},J&&{columns:q,columnChecks:H,addColumn:J.addColumn,removeColumn:J.removeColumn,toggleColumn:J.toggleColumn,updateColumn:J.updateColumn,batchUpdateColumns:J.batchUpdateColumns,reorderColumns:J.reorderColumns,getColumnConfig:J.getColumnConfig,getAllColumns:J.getAllColumns,resetColumns:J.resetColumns})}(e)}export{I as E,X as u};
